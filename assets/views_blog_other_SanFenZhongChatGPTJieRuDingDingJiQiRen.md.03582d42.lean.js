import{_ as l,o,c as e,S as p,C as a,a as n}from"./chunks/framework.7114eebe.js";const g=JSON.parse('{"title":"三分钟 ChatGPT 接入钉钉机器人","description":"","frontmatter":{"title":"三分钟 ChatGPT 接入钉钉机器人","date":"2023/04/22 15:21:15","summary":null,"config":{"show":true,"top":false,"dir":true,"dirTag":["h3","h4","h5"],"tag":["tool","info"],"valine":true,"valineId":null},"password":false,"outline":[3,5]},"headers":[],"relativePath":"views/blog/other/SanFenZhongChatGPTJieRuDingDingJiQiRen.md","filePath":"views/blog/other/SanFenZhongChatGPTJieRuDingDingJiQiRen.md"}'),t={name:"views/blog/other/SanFenZhongChatGPTJieRuDingDingJiQiRen.md"},c={class:"markdown-body cache"},r={href:"https://link.juejin.cn?target=https%3A%2F%2Fchat.openai.com%2F",target:"_blank",title:"https://chat.openai.com/",ref:"nofollow noopener noreferrer"},y={href:"https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Faccount%2Fapi-keys",target:"_blank",title:"https://platform.openai.com/account/api-keys",ref:"nofollow noopener noreferrer"},F={href:"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flabring%2Flaf",target:"_blank",title:"https://github.com/labring/laf",ref:"nofollow noopener noreferrer"},D={href:"https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4dFYECnicvvTOWhuL8F-Q",target:"_blank",title:"https://mp.weixin.qq.com/s/Z4dFYECnicvvTOWhuL8F-Q",ref:"nofollow noopener noreferrer"},i={href:"https://link.juejin.cn?target=https%3A%2F%2Fopen-dev.dingtalk.com%2Ffe%2Fapp%23%2Fcorp%2Frobot",target:"_blank",title:"https://open-dev.dingtalk.com/fe/app#/corp/robot",ref:"nofollow noopener noreferrer"};function B(d,s,A,E,f,u){return o(),e("div",null,[s[22]||(s[22]=p('<h6 id="原文-掘金" tabindex="-1">原文 <a href="https://juejin.cn/post/7211061398680305725" target="_blank" rel="noreferrer">掘金</a> <a class="header-anchor" href="#原文-掘金" aria-label="Permalink to &quot;原文 [掘金](https://juejin.cn/post/7211061398680305725)&quot;">​</a></h6><h6 id="国内免费体验" tabindex="-1"><a href="https://chat.waixingyun.cn/" target="_blank" rel="noreferrer">国内免费体验</a> <a class="header-anchor" href="#国内免费体验" aria-label="Permalink to &quot;[国内免费体验](https://chat.waixingyun.cn/)&quot;">​</a></h6>',2)),a("div",c,[s[5]||(s[5]=p('<h3 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h3><p>ChatGPT 大家应该都已经用了一段时间了，功能非常强大，作为开发人员，我用它写文档、写日报、润色 OKR，知识搜索等等，它给我带来了极大的帮助，但我在使用过程中最大的痛点就是网络。</p><h3 id="痛点" tabindex="-1">痛点 <a class="header-anchor" href="#痛点" aria-label="Permalink to &quot;痛点&quot;">​</a></h3><p>由于国内不能访问的原因，我们必须使用代理，而且必须选择日本或美国较远的节点，香港跟台湾是不能访问的，而在工作的时候，需要访问内网，因此我每天要在切换代理这件事上花不少时间。</p><p>现在我们可以在钉钉中直接对接 ChatGPT，再也不必为了切换网络而烦恼了。</p><h3 id="原理" tabindex="-1">原理 <a class="header-anchor" href="#原理" aria-label="Permalink to &quot;原理&quot;">​</a></h3><p>首先来说一下原理：</p>',7)),a("p",null,[a("a",r,"chat.openai.com/",512),s[0]||(s[0]=n(" 这个网站必须是国外节点才可以访问，而我们使用官方的 api，就可以使用香港节点访问。"))]),s[6]||(s[6]=p(`<p>比如我们使用以下代码，这样就可以在 Nodejs 中调用 ChatGPT API 了。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> payload</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">OpenAIStreamPayload</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">model</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">gpt-3.5-turbo</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">messages</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">role</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">content</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> prompt </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">temperature</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0.7</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">top_p</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">frequency_penalty</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">presence_penalty</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">max_tokens</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">800</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">n</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">fetch</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://api.openai.com/v1/chat/completions</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">headers</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">Content-Type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">application/json</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">Authorization</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">Bearer </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">OPENAI_API_KEY </span><span style="color:#89DDFF;">??</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;&quot;}\`</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">method</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">POST</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#BABED8;">(payload)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre></div>`,2)),a("p",null,[s[1]||(s[1]=n("上述代码中 OPENAI_API_KEY 需要")),a("a",y,"登录自己账号",512),s[2]||(s[2]=n("，自己创建一个。"))]),s[7]||(s[7]=a("p",null,[a("img",{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4898ce71bf2a4940813336fb6e6c906f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?",alt:"复制 OPENAI API_KEY",loading:"lazy"})],-1)),s[8]||(s[8]=a("p",null,"接下来我们需要准备一个可以直接访问 OpenAi API 的 Node.js 环境。",-1)),s[9]||(s[9]=a("p",null,"有没有一种简单快捷的方法来调用 ChatGPT API 呢？",-1)),s[10]||(s[10]=a("p",null,"那当然是用 Laf 了。",-1)),s[11]||(s[11]=a("p",null,"Laf 是一个完全开源的一站式云开发平台，提供了开箱即用的云函数，云数据库，对象存储等能力，让你可以像写博客一样写代码。",-1)),a("blockquote",null,[a("p",null,[s[3]||(s[3]=n("GitHub：")),a("a",F,"github.com/labring/laf",512)])]),s[12]||(s[12]=p(`<p>最重要的是云服务可用区在香港，那么我们就可以搭建一个自己的 ChatGPT 了。</p><h3 id="实现步骤" tabindex="-1">实现步骤 <a class="header-anchor" href="#实现步骤" aria-label="Permalink to &quot;实现步骤&quot;">​</a></h3><p>首先需要登录  laf.dev，然后新建一个应用。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2feda7251c64dd8b9fef305eebfdf1b~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image" alt="创建应用" loading="lazy"></p><p>点击开发按钮进入开发页面。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f82c56a9411f42b9a8788d06fbe097b9~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="进入开发" loading="lazy"></p><p>在 NPM 依赖面板中点击右上角的  <code>+</code>，安装 npm 包 chatgpt，<strong>保存并重启：</strong></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9be1b689382a4e67bf4625a5ba331232~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="安装npm依赖" loading="lazy"></p><p>新建一个云函数，选 post，函数名称随便取</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ba2977af61845abb7c29ddc184f256f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="新建云函数" loading="lazy"></p><p>然后再贴入以下代码：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> cloud </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@lafjs/cloud</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> axios </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">axios</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> dingtalk_robot_url </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://oapi.dingtalk.com/robot/send?access_token=55c8f230c7cb6b18c51e182bc6a2ae41b84fa4e30c3d5d9dee4ae3a</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> sendDingDing </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">async</span><span style="color:#BABED8;"> (md) </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">sendMessage</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    msgtype</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">markdown</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    markdown</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      title</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">掘金消息</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">md</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">axios</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">post</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">dingtalk_robot_url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">sendMessage</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">ctx</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">FunctionContext</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// body, query 为请求参数, auth 是授权对象</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">auth</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">body</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">query</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ctx</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 数据库操作</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// const db = cloud.database()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// const r = await db.collection(&#39;admins&#39;).get()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ChatGPTAPI</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">import</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">chatgpt</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">api</span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">api</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">api</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">api</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">ChatGPTAPI</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> apiKey</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">OPENAI_API_KEY</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">api</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">api</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">prompt</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">body</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">text</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">content</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">parentMessageId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">parentMessageId</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">res</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 这里前端如果传过来 parentMessageId 则代表需要追踪上下文</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">parentMessageId</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendMessage</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">prompt</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendMessage</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">prompt</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">parentMessageId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">parentMessageId</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">id</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">text</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">sendDingDing</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">text</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>上面代码中，还有 2 步方需要修改下：</p><p>第一个是设置环境变量 <code>OPENAI_API_KEY</code></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9701c4a6a8e4788914608b535b39457~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="设置环境变量" loading="lazy"></p><p>第二个是修改 <code>dingtalk_robot_url</code>， 这个钉钉机器人的回调地址。</p><h3 id="钉钉机器人对接" tabindex="-1">钉钉机器人对接 <a class="header-anchor" href="#钉钉机器人对接" aria-label="Permalink to &quot;钉钉机器人对接&quot;">​</a></h3><p>新建一个只有你自己的个人群</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a9ef31bb1d447d9811e0535ca0e772a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="钉钉群助手" loading="lazy"></p><p>点击群助手创建一个自定义的 <code>webhook</code></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/563496725bde41f68b0c81651e385e8b~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="添加机器人" loading="lazy"></p><p>安全设置选择自定义关键词，输入掘金消息 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cdbddfadcb934987878f6a48f1fb9773~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="创建机器人" loading="lazy"></p><p>复制 <code>webhook</code> 地址，这个就是 <code>dingtalk_robot_url</code>, 更新到云函数中，保存并发布。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a84e5598570943e7bd0b7d5344314cf8~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="复制云函数url" loading="lazy"></p><p>点击复制云函数 url，我们设置到钉钉机器人中</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad6ee865d4f644a59d75cae69cd1d62e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="设置钉钉机器人" loading="lazy"></p><p>填入你的云函数地址，这样我们就可以在钉钉中 <code>@机器人</code>,它每次会将消息内容推送给原函数，云函数处理消息后，将消息推送给钉钉。</p><p>接下来我们就可以在钉钉中愉快地和 ChatGPT 对话了。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67424a6f10954760accf7f43ee303cf0~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?" alt="对话演示" loading="lazy"></p><p>当然消息也会同步在手机中，我们也可以使用手机和机器人对话。</p><h3 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h3><p>缺点是这个机器人还不支持连续对话，因为钉钉机器人不支持消息 id 的记录，其实 ChatGPT 是支持理解上下文的。 只需要在 <code>ChatGPTAPI</code> 中传入 <code>parentMessageId</code> 就可以了。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">res </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#BABED8;"> api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendMessage</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">What were we talking about?</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">parentMessageId</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> res</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">id</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre></div><p>如果这个群聊只有一个人使用的话，我们可以将 <code>parentMessageId</code> 存入云数据库中，或云函数的共享中。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">parentMessageId</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#BABED8;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">parentMessageId</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span></code></pre></div><p>这样就可以实现连续对话了。</p><p>好了，以上就是本文全部内容，如果对你有帮助，随手点个赞吧</p>`,37)),a("p",null,[s[4]||(s[4]=n("参考 ")),a("a",D,"《 三分钟拥有自己的 ChatGPT (从开发到上线)》",512)]),s[13]||(s[13]=a("h3",{id:"补充",tabindex:"-1"},[n("补充 "),a("a",{class:"header-anchor",href:"#补充","aria-label":'Permalink to "补充"'},"​")],-1)),s[14]||(s[14]=a("p",null,"有些同学问： 钉钉机器人没有 post 设置的该怎么办？",-1)),s[15]||(s[15]=a("p",null,"首先登录自己的账号创建一个机器人",-1)),a("p",null,[a("a",i,"open-dev.dingtalk.com/fe/app#/cor…",512)]),s[16]||(s[16]=a("p",null,[a("img",{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/769188ad80cf4ba4ac392aff75c1d4b1~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?",alt:"image.png",loading:"lazy"})],-1)),s[17]||(s[17]=a("p",null,"选择继续使用旧版创建机器人，",-1)),s[18]||(s[18]=a("p",null,"创建完成后， 在消息接收地址中填写post地址即可。 这个地址可以通过@群机器人，将消息发送到指定外部服务，还可以将外部服务的响应结果返回到群组。这里填写一个公网可访问的HTTPS/HTTP地址，用于接收POST过来的消息。",-1)),s[19]||(s[19]=a("p",null,[a("img",{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac908416497048b89b824a784fccb5db~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image?",alt:"image.png",loading:"lazy"})],-1)),s[20]||(s[20]=a("p",null,"此时在钉钉中，你会自动加入一个群聊，你可以在这个群中和机器人对话测试",-1)),s[21]||(s[21]=a("hr",null,null,-1))])])}const b=l(t,[["render",B]]);export{g as __pageData,b as default};
