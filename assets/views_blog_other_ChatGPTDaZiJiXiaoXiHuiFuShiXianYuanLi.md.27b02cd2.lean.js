import{_ as p,o,c as e,C as n,a,S as l}from"./chunks/framework.7114eebe.js";const u=JSON.parse('{"title":"ChatGPT æ‰“å­—æœºæ¶ˆæ¯å›å¤å®ç°åŸç†","description":"","frontmatter":{"title":"ChatGPT æ‰“å­—æœºæ¶ˆæ¯å›å¤å®ç°åŸç†","date":"2023/05/16 17:27:30","summary":null,"config":{"show":true,"top":false,"dir":true,"dirTag":["h3","h4","h5"],"tag":["info","js","tool"],"valine":true,"valineId":null},"password":false,"outline":[3,5]},"headers":[],"relativePath":"views/blog/other/ChatGPTDaZiJiXiaoXiHuiFuShiXianYuanLi.md","filePath":"views/blog/other/ChatGPTDaZiJiXiaoXiHuiFuShiXianYuanLi.md"}'),t={name:"views/blog/other/ChatGPTDaZiJiXiaoXiHuiFuShiXianYuanLi.md"},c={class:"markdown-body cache"},r={href:"https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2F%3Fsearch%3DServer%2520-sent%2520events",target:"_blank",title:"https://caniuse.com/?search=Server%20-sent%20events",ref:"nofollow noopener noreferrer"},y={href:"https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feventsource",target:"_blank",title:"https://www.npmjs.com/package/eventsource",ref:"nofollow noopener noreferrer"},F={href:"https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F417142",target:"_blank",title:"https://stackoverflow.com/questions/417142",ref:"nofollow noopener noreferrer"};function D(i,s,B,E,A,d){return o(),e("div",null,[s[14]||(s[14]=n("h6",{id:"åŸæ–‡-æ˜é‡‘",tabindex:"-1"},[a("åŸæ–‡ "),n("a",{href:"https://juejin.cn/post/7229632570374783034",target:"_blank",rel:"noreferrer"},"æ˜é‡‘"),a(),n("a",{class:"header-anchor",href:"#åŸæ–‡-æ˜é‡‘","aria-label":'Permalink to "åŸæ–‡ [æ˜é‡‘](https://juejin.cn/post/7229632570374783034)"'},"â€‹")],-1)),n("div",c,[s[10]||(s[10]=l(`<blockquote><p>ğŸ””æ¦‚è¿°ï¼š</p><p>ç›¸è¾ƒäºç¹é‡çš„ WebSocketsï¼ŒSSE æ— ç–‘æ˜¯ H5 ç®€å•å³æ—¶æ•°æ®æ›´æ–°çš„è½»é‡çº§ä»£æ›¿æ–¹æ¡ˆã€‚</p></blockquote><h2 id="_1-èƒŒæ™¯" tabindex="-1">1 èƒŒæ™¯ <a class="header-anchor" href="#_1-èƒŒæ™¯" aria-label="Permalink to &quot;1 èƒŒæ™¯&quot;">â€‹</a></h2><p>â€‹ åœ¨ä½¿ç”¨ ChatGPT æ—¶ï¼Œå‘ç°è¾“å…¥ prompt åï¼Œé¡µé¢æ˜¯é€æ­¥ç»™å‡ºå›å¤çš„ï¼Œèµ·åˆä»¥ä¸ºä½¿ç”¨äº† WebSckets æŒä¹…åŒ–è¿æ¥åè®®ï¼ŒæŸ¥çœ‹å…¶ç½‘ç»œè¯·æ±‚ï¼Œå‘ç°è¿™ä¸ªæ¥å£çš„é€šä¿¡æ–¹å¼å¹¶éä¼ ç»Ÿçš„ http æ¥å£æˆ–è€… WebSocketsï¼Œè€Œæ˜¯åŸºäº EventStream çš„äº‹ä»¶æµï¼Œåƒæ‰“å­—æœºä¸€æ ·ï¼Œä¸€æ®µä¸€æ®µçš„è¿”å›ç­”æ¡ˆã€‚</p><p>â€‹ ChatGPT æ˜¯ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„å¤§å‹è¯­è¨€æ¨¡å‹ï¼Œå¤„ç†è‡ªç„¶è¯­è¨€éœ€è¦å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œå“åº”é€Ÿåº¦è‚¯å®šæ¯”æ™®é€šçš„è¯»æ•°æ®åº“è¦æ…¢çš„å¤šï¼Œæ™®é€š http æ¥å£ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œæ˜¾ç„¶å¹¶ä¸åˆé€‚ã€‚å¯¹äºè¿™ç§å•é¡¹å¯¹è¯åœºæ™¯ï¼ŒChagtGPT å°†å…ˆè®¡ç®—å‡ºçš„æ•°æ®â€œæ¨é€â€ç»™ç”¨æˆ·ï¼Œè¾¹è®¡ç®—è¾¹è¿”å›ï¼Œé¿å…ç”¨æˆ·å› ä¸ºç­‰å¾…æ—¶é—´è¿‡é•¿å…³é—­é¡µé¢ã€‚è€Œè¿™ï¼Œå¯ä»¥é‡‡ç”¨ SSE æŠ€æœ¯ã€‚</p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5b84e8f12c1411facfe13ca2eadc19d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image" alt="2023-04-09 16.09.32" loading="lazy"><h2 id="_2-æ¦‚è¿°" tabindex="-1">2 æ¦‚è¿° <a class="header-anchor" href="#_2-æ¦‚è¿°" aria-label="Permalink to &quot;2 æ¦‚è¿°&quot;">â€‹</a></h2><p>â€‹ Server-Sent Events æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼Œç®€ç§° SSEï¼Œæ˜¯ä¸€ç§æœåŠ¡ç«¯å®æ—¶<strong>ä¸»åŠ¨</strong>å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯çš„æŠ€æœ¯ã€‚</p><p>â€‹ SSE æ˜¯ HTML5 ä¸­ä¸€ä¸ªä¸é€šä¿¡ç›¸å…³çš„ APIï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šæœåŠ¡ç«¯ä¸æµè§ˆå™¨ç«¯çš„é€šä¿¡åè®®ï¼ˆ<code>HTTP</code> åè®®ï¼‰åŠæµè§ˆå™¨ç«¯å¯ä¾› JavaScript ä½¿ç”¨çš„ <code>EventSource</code> å¯¹è±¡ã€‚</p><p>â€‹ ä»â€œæœåŠ¡ç«¯ä¸»åŠ¨å‘æµè§ˆå™¨å®æ—¶æ¨é€æ¶ˆæ¯â€è¿™ä¸€ç‚¹æ¥çœ‹ï¼Œè¯¥ API ä¸ WebSockets API æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ã€‚ä½†æ˜¯ï¼Œè¯¥ API ä¸ WebSockers API çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š</p><table><thead><tr><th align="center">Server-Sent Events API</th><th align="center">WebSockets API</th></tr></thead><tbody><tr><td align="center">åŸºäº HTTP åè®®</td><td align="center">åŸºäº TCP åè®®</td></tr><tr><td align="center">å•å·¥ï¼Œåªèƒ½æœåŠ¡ç«¯å•å‘å‘é€æ¶ˆæ¯</td><td align="center">å…¨åŒå·¥ï¼Œå¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯</td></tr><tr><td align="center">è½»é‡çº§ï¼Œä½¿ç”¨ç®€å•</td><td align="center">ç›¸å¯¹å¤æ‚</td></tr><tr><td align="center">å†…ç½®æ–­çº¿é‡è¿å’Œæ¶ˆæ¯è¿½è¸ªçš„åŠŸèƒ½</td><td align="center">ä¸åœ¨åè®®èŒƒå›´å†…ï¼Œéœ€æ‰‹åŠ¨å®ç°</td></tr><tr><td align="center">æ–‡æœ¬æˆ–ä½¿ç”¨ Base64 ç¼–ç å’Œ gzip å‹ç¼©çš„äºŒè¿›åˆ¶æ¶ˆæ¯</td><td align="center">ç±»å‹å¹¿æ³›</td></tr><tr><td align="center">æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶ç±»å‹</td><td align="center">ä¸æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶ç±»å‹</td></tr><tr><td align="center">è¿æ¥æ•° HTTP/1.1 6 ä¸ªï¼ŒHTTP/2 å¯åå•†ï¼ˆé»˜è®¤ 100ï¼‰</td><td align="center">è¿æ¥æ•°æ— é™åˆ¶</td></tr></tbody></table><h2 id="_3-æœåŠ¡ç«¯å®ç°" tabindex="-1">3 æœåŠ¡ç«¯å®ç° <a class="header-anchor" href="#_3-æœåŠ¡ç«¯å®ç°" aria-label="Permalink to &quot;3 æœåŠ¡ç«¯å®ç°&quot;">â€‹</a></h2><h3 id="_3-1-åè®®" tabindex="-1">3.1 åè®® <a class="header-anchor" href="#_3-1-åè®®" aria-label="Permalink to &quot;3.1 åè®®&quot;">â€‹</a></h3><p>â€‹ SSE åè®®éå¸¸ç®€å•ï¼Œæœ¬è´¨æ˜¯æµè§ˆå™¨å‘èµ· http è¯·æ±‚ï¼ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œè¿”å›çŠ¶æ€ä¸æ•°æ®ï¼Œå¹¶é™„å¸¦ä»¥ä¸‹ headersï¼š</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">Content</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Type</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> text</span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">event</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">stream</span></span>
<span class="line"><span style="color:#BABED8;">Cache</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Control</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> no</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">cache</span></span>
<span class="line"><span style="color:#FFCB6B;">Connection</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> keep</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">alive</span></span></code></pre></div><ul><li>SSE APIè§„å®šæ¨é€äº‹ä»¶æµçš„ MIME ç±»å‹ä¸º <code>text/event-stream</code>ã€‚</li><li>å¿…é¡»æŒ‡å®šæµè§ˆå™¨ä¸ç¼“å­˜æœåŠ¡ç«¯å‘é€çš„æ•°æ®ï¼Œä»¥ç¡®ä¿æµè§ˆå™¨å¯ä»¥å®æ—¶æ˜¾ç¤ºæœåŠ¡ç«¯å‘é€çš„æ•°æ®ã€‚</li><li>SSE æ˜¯ä¸€ä¸ªä¸€ç›´ä¿æŒå¼€å¯çš„ TCP è¿æ¥ï¼Œæ‰€ä»¥ Connection ä¸º keep-aliveã€‚</li></ul><h3 id="_3-2-æ¶ˆæ¯æ ¼å¼" tabindex="-1">3.2 æ¶ˆæ¯æ ¼å¼ <a class="header-anchor" href="#_3-2-æ¶ˆæ¯æ ¼å¼" aria-label="Permalink to &quot;3.2 æ¶ˆæ¯æ ¼å¼&quot;">â€‹</a></h3><p>â€‹ EventStreamï¼ˆäº‹ä»¶æµï¼‰ä¸º <code>UTF-8</code> æ ¼å¼ç¼–ç çš„<code>æ–‡æœ¬</code>æˆ–ä½¿ç”¨ Base64 ç¼–ç å’Œ gzip å‹ç¼©çš„äºŒè¿›åˆ¶æ¶ˆæ¯ã€‚</p><p>â€‹ æ¯æ¡æ¶ˆæ¯ç”±ä¸€è¡Œæˆ–å¤šè¡Œå­—æ®µï¼ˆ<code>event</code>ã€<code>id</code>ã€<code>retry</code>ã€<code>data</code>ï¼‰ç»„æˆï¼Œæ¯ä¸ªå­—æ®µç»„æˆå½¢å¼ä¸ºï¼š<code>å­—æ®µå:å­—æ®µå€¼</code>ã€‚å­—æ®µä»¥è¡Œä¸ºå•ä½ï¼Œæ¯è¡Œä¸€ä¸ªï¼ˆå³ä»¥ <code>\\n</code> ç»“å°¾ï¼‰ã€‚ä»¥<code>å†’å·</code>å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Šè¡Œï¼Œä¼šè¢«æµè§ˆå™¨å¿½ç•¥ã€‚</p><p>â€‹ æ¯æ¬¡æ¨é€ï¼Œå¯ç”±å¤šä¸ªæ¶ˆæ¯ç»„æˆï¼Œæ¯ä¸ªæ¶ˆæ¯ä¹‹é—´ä»¥ç©ºè¡Œåˆ†éš”ï¼ˆå³æœ€åä¸€ä¸ªå­—æ®µä»¥<code>\\n\\n</code>ç»“å°¾ï¼‰ã€‚</p><blockquote><p>ğŸ“¢ æ³¨æ„ï¼š</p><ul><li>é™¤ä¸Šè¿°å››ä¸ªå­—æ®µå¤–ï¼Œå…¶ä»–æ‰€æœ‰å­—æ®µéƒ½ä¼šè¢«å¿½ç•¥ã€‚</li><li>å¦‚æœä¸€è¡Œå­—æ®µä¸­ä¸åŒ…å«å†’å·ï¼Œåˆ™æ•´è¡Œæ–‡æœ¬å°†è¢«è§†ä¸ºå­—æ®µåï¼Œå­—æ®µå€¼ä¸ºç©ºã€‚</li><li>æ³¨é‡Šè¡Œå¯ä»¥ç”¨æ¥é˜²æ­¢é“¾æ¥è¶…æ—¶ï¼ŒæœåŠ¡ç«¯å¯ä»¥å®šæœŸå‘æµè§ˆå™¨å‘é€ä¸€æ¡æ¶ˆæ¯æ³¨é‡Šè¡Œï¼Œä»¥ä¿æŒè¿æ¥ä¸æ–­ã€‚</li></ul></blockquote><h4 id="_3-2-1-event" tabindex="-1">3.2.1 event <a class="header-anchor" href="#_3-2-1-event" aria-label="Permalink to &quot;3.2.1 event&quot;">â€‹</a></h4><p>â€‹ äº‹ä»¶ç±»å‹ã€‚å¦‚æœæŒ‡å®šäº†è¯¥å­—æ®µï¼Œåˆ™åœ¨æµè§ˆå™¨æ”¶åˆ°è¯¥æ¡æ¶ˆæ¯æ—¶ï¼Œä¼šåœ¨å½“å‰ <code>EventSource</code> å¯¹è±¡ï¼ˆè§ 4ï¼‰ä¸Šè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹å°±æ˜¯è¯¥å­—æ®µçš„å­—æ®µå€¼ã€‚å¯ä»¥ä½¿ç”¨ <code>addEventListener</code> æ–¹æ³•åœ¨å½“å‰ <code>EventSource</code> å¯¹è±¡ä¸Šç›‘å¬ä»»æ„ç±»å‹çš„å‘½åäº‹ä»¶ã€‚</p><p>â€‹ å¦‚æœè¯¥æ¡æ¶ˆæ¯æ²¡æœ‰ <code>event</code> å­—æ®µï¼Œåˆ™ä¼šè§¦å‘ <code>EventSource</code> å¯¹è±¡ <code>onmessage</code> å±æ€§ä¸Šçš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚</p><h4 id="_3-2-2-id" tabindex="-1">3.2.2 id <a class="header-anchor" href="#_3-2-2-id" aria-label="Permalink to &quot;3.2.2 id&quot;">â€‹</a></h4><p>â€‹ äº‹ä»¶IDã€‚äº‹ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæµè§ˆå™¨ä¼šè·Ÿè¸ªäº‹ä»¶IDï¼Œå¦‚æœå‘ç”Ÿæ–­è¿ï¼Œæµè§ˆå™¨ä¼šæŠŠæ”¶åˆ°çš„æœ€åä¸€ä¸ªäº‹ä»¶IDæ”¾åˆ° HTTP Header <code>Last-Event-Id</code> ä¸­è¿›è¡Œé‡è¿ï¼Œä½œä¸ºä¸€ç§ç®€å•çš„åŒæ­¥æœºåˆ¶ã€‚</p><p>â€‹ ä¾‹å¦‚å¯ä»¥åœ¨æœåŠ¡ç«¯å°†æ¯æ¬¡å‘é€çš„äº‹ä»¶IDå€¼è‡ªåŠ¨åŠ  1ï¼Œå½“æµè§ˆå™¨æ¥æ”¶åˆ°è¯¥äº‹ä»¶IDåï¼Œä¸‹æ¬¡ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥åå†è¯·æ±‚çš„ Header ä¸­å°†åŒæ—¶æäº¤è¯¥äº‹ä»¶IDï¼ŒæœåŠ¡ç«¯æ£€æŸ¥è¯¥äº‹ä»¶IDæ˜¯å¦ä¸ºä¸Šæ¬¡å‘é€çš„äº‹ä»¶IDï¼Œå¦‚æœä¸ä¸Šæ¬¡å‘é€çš„äº‹ä»¶IDä¸ä¸€è‡´åˆ™è¯´æ˜æµè§ˆå™¨å­˜åœ¨ä¸æœåŠ¡å™¨è¿æ¥å¤±è´¥çš„æƒ…å†µï¼Œæœ¬æ¬¡éœ€è¦åŒæ—¶å‘é€å‰å‡ æ¬¡æµè§ˆå™¨æœªæ¥æ”¶åˆ°çš„æ•°æ®ã€‚</p><h4 id="_3-2-3-retry" tabindex="-1">3.2.3 retry <a class="header-anchor" href="#_3-2-3-retry" aria-label="Permalink to &quot;3.2.3 retry&quot;">â€‹</a></h4><p>â€‹ é‡è¿æ—¶é—´ã€‚æ•´æ•°å€¼ï¼Œå•ä½ msï¼Œå¦‚æœä¸æœåŠ¡å™¨çš„è¿æ¥ä¸¢å¤±ï¼Œæµè§ˆå™¨å°†ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œç„¶åå°è¯•é‡æ–°è¿æ¥ã€‚å¦‚æœè¯¥å­—æ®µä¸æ˜¯æ•´æ•°å€¼ï¼Œä¼šè¢«å¿½ç•¥ã€‚</p><p>â€‹ å½“æœåŠ¡ç«¯æ²¡æœ‰æŒ‡å®šæµè§ˆå™¨çš„é‡è¿æ—¶é—´æ—¶ï¼Œç”±æµè§ˆå™¨è‡ªè¡Œå†³å®šæ¯éš”å¤šä¹…ä¸æœåŠ¡ç«¯å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼ˆä¸€èˆ¬ä¸º 30sï¼‰ã€‚</p><h4 id="_3-2-4-data" tabindex="-1">3.2.4 data <a class="header-anchor" href="#_3-2-4-data" aria-label="Permalink to &quot;3.2.4 data&quot;">â€‹</a></h4><p>â€‹ æ¶ˆæ¯æ•°æ®ã€‚æ•°æ®å†…å®¹åªèƒ½ä»¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ–‡æœ¬å½¢å¼è¿›è¡Œå‘é€ï¼Œå¦‚æœéœ€è¦å‘é€ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œéœ€è¦å°†è¯¥å¯¹è±¡ä»¥ä¸€ä¸ª JSON æ ¼å¼çš„å­—ç¬¦ä¸²çš„å½¢å¼è¿›è¡Œå‘é€ã€‚åœ¨æµè§ˆå™¨æ¥æ”¶åˆ°è¯¥å­—ç¬¦ä¸²åï¼Œå†æŠŠå®ƒè¿˜åŸä¸ºä¸€ä¸ª JSON å¯¹è±¡ã€‚</p><h3 id="_3-3-ç¤ºä¾‹" tabindex="-1">3.3 ç¤ºä¾‹ <a class="header-anchor" href="#_3-3-ç¤ºä¾‹" aria-label="Permalink to &quot;3.3 ç¤ºä¾‹&quot;">â€‹</a></h3><p>â€‹ å¦‚ä¸‹äº‹ä»¶æµç¤ºä¾‹ï¼Œå…±å‘é€äº† 4 æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯é—´ä»¥ä¸€ä¸ªç©ºè¡Œä½œä¸ºåˆ†éš”ç¬¦ã€‚</p><p>â€‹ ç¬¬ä¸€æ¡ä»…ä»…æ˜¯ä¸ªæ³¨é‡Šï¼Œå› ä¸ºå®ƒä»¥å†’å·å¼€å¤´ã€‚</p><p>â€‹ ç¬¬äºŒæ¡æ¶ˆæ¯åªåŒ…å«ä¸€ä¸ª data å­—æ®µï¼Œå€¼ä¸º &#39;this is second message&#39;ã€‚</p><p>â€‹ ç¬¬ä¸‰æ¡æ¶ˆæ¯åŒ…å«ä¸¤ä¸ª data å­—æ®µï¼Œå…¶ä¼šè¢«è§£æä¸ºä¸€ä¸ªå­—æ®µï¼Œå€¼ä¸º &#39;this is third message part 1\\nthis is third message part 2&#39;ã€‚</p><p>â€‹ ç¬¬å››æ¡æ¶ˆæ¯åŒ…å«å®Œæ•´å››ä¸ªå­—æ®µï¼ŒæŒ‡å®šäº†äº‹ä»¶ç±»å‹ä¸º &#39;server-time&#39;ï¼Œäº‹ä»¶id ä¸º &#39;1&#39;ï¼Œé‡è¿æ—¶é—´ä¸º &#39;30000&#39;msï¼Œæ¶ˆæ¯æ•°æ®ä¸º <code>JSON</code> æ ¼å¼çš„ &#39;{&quot;text&quot;: &quot;this is fourth message&quot;, &quot;time&quot;: &quot;12:00:00&quot;}&#39;ã€‚</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">: </span><span style="color:#89DDFF;">this</span><span style="color:#BABED8;"> is first message\\n\\n</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">data</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">this</span><span style="color:#BABED8;"> is second message\\n\\n</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">data</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">this</span><span style="color:#BABED8;"> is third message part one\\n</span></span>
<span class="line"><span style="color:#BABED8;">data </span><span style="color:#89DDFF;">this</span><span style="color:#BABED8;"> is third message part two\\n\\n</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">event</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> server</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">time\\n</span></span>
<span class="line"><span style="color:#FFCB6B;">id</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#FFCB6B;">retry</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">30000</span><span style="color:#BABED8;">\\n</span></span>
<span class="line"><span style="color:#FFCB6B;">data</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">this is fourth message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">time</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">2023-04-09 12:00:00</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">\\n\\n</span></span></code></pre></div><h2 id="_4-æµè§ˆå™¨-api" tabindex="-1">4 æµè§ˆå™¨ API <a class="header-anchor" href="#_4-æµè§ˆå™¨-api" aria-label="Permalink to &quot;4 æµè§ˆå™¨ API&quot;">â€‹</a></h2><p>â€‹ åœ¨æµè§ˆå™¨ç«¯ï¼Œå¯ä»¥ä½¿ç”¨ JavaScript çš„ EventSource API åˆ›å»º <code>EventSource</code> å¯¹è±¡ç›‘å¬æœåŠ¡å™¨å‘é€çš„äº‹ä»¶ã€‚ä¸€æ—¦å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥ä½¿ç”¨ HTTP å“åº”çš„ &#39;text/event-stream&#39; å†…å®¹ç±»å‹å‘é€äº‹ä»¶æ¶ˆæ¯ï¼Œæµè§ˆå™¨åˆ™å¯ä»¥é€šè¿‡ç›‘å¬ EventSource å¯¹è±¡çš„ <code>onmessage</code>ã€<code>onopen</code> å’Œ <code>onerror</code> äº‹ä»¶æ¥å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</p><h3 id="_4-1-å»ºç«‹è¿æ¥" tabindex="-1">4.1 å»ºç«‹è¿æ¥ <a class="header-anchor" href="#_4-1-å»ºç«‹è¿æ¥" aria-label="Permalink to &quot;4.1 å»ºç«‹è¿æ¥&quot;">â€‹</a></h3><p>â€‹ EventSource æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šURL å’Œ optionsã€‚</p><p>â€‹ URL ä¸º http äº‹ä»¶æ¥æºï¼Œä¸€æ—¦ EventSource å¯¹è±¡è¢«åˆ›å»ºåï¼Œæµè§ˆå™¨ç«‹å³å¼€å§‹å¯¹è¯¥ URL åœ°å€å‘é€è¿‡æ¥çš„äº‹ä»¶è¿›è¡Œç›‘å¬ã€‚</p><p>â€‹ options æ˜¯ä¸€ä¸ªå¯é€‰çš„å¯¹è±¡ï¼ŒåŒ…å« withCredentials å±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦å‘é€å‡­è¯ï¼ˆcookieã€HTTPè®¤è¯ä¿¡æ¯ç­‰ï¼‰åˆ°æœåŠ¡ç«¯ï¼Œé»˜è®¤ä¸º falseã€‚</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> eventSource </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">EventSource</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http_api_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">withCredentials</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre></div><p>â€‹ ä¸ XMLHttpRequest å¯¹è±¡ç±»å‹ï¼ŒEventSource å¯¹è±¡æœ‰ä¸€ä¸ª readyState å±æ€§å€¼ï¼Œå…·ä½“å«ä¹‰å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">readyState</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">æµè§ˆå™¨ä¸æœåŠ¡ç«¯å°šæœªå»ºç«‹è¿æ¥æˆ–è¿æ¥å·²è¢«å…³é—­</td></tr><tr><td align="center">1</td><td align="center">æµè§ˆå™¨ä¸æœåŠ¡ç«¯å·²æˆåŠŸè¿æ¥ï¼Œæµè§ˆå™¨æ­£åœ¨å¤„ç†æ¥æ”¶åˆ°çš„äº‹ä»¶åŠæ•°æ®</td></tr><tr><td align="center">2</td><td align="center">æµè§ˆå™¨ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥å¤±è´¥ï¼Œå®¢æˆ·ç«¯ä¸å†ç»§ç»­å»ºç«‹ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¿æ¥</td></tr></tbody></table><p>â€‹ å¯ä»¥ä½¿ç”¨ EventSource å¯¹è±¡çš„ <code>close</code> æ–¹æ³•å…³é—­ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¿æ¥ï¼Œä½¿æµè§ˆå™¨ä¸å†å»ºç«‹ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¿æ¥ã€‚</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// åˆå§‹åŒ– eventSource ç­‰çœç•¥</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å…³é—­è¿æ¥</span></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#BABED8;">()</span></span></code></pre></div><h3 id="_4-2-ç›‘å¬äº‹ä»¶" tabindex="-1">4.2 ç›‘å¬äº‹ä»¶ <a class="header-anchor" href="#_4-2-ç›‘å¬äº‹ä»¶" aria-label="Permalink to &quot;4.2 ç›‘å¬äº‹ä»¶&quot;">â€‹</a></h3><p>â€‹ EventSource å¯¹è±¡æœ¬èº«ç»§æ‰¿è‡ª EventTarget æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ addEventListener() æ–¹æ³•æ¥ç›‘å¬äº‹ä»¶ã€‚EventSource å¯¹è±¡è§¦å‘çš„äº‹ä»¶ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li>open äº‹ä»¶ï¼šå½“æˆåŠŸè¿æ¥åˆ°æœåŠ¡ç«¯æ—¶è§¦å‘ã€‚</li><li>message äº‹ä»¶ï¼šå½“æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯æ—¶è§¦å‘ã€‚è¯¥äº‹ä»¶å¯¹è±¡çš„ data å±æ€§åŒ…å«äº†æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯å†…å®¹ã€‚</li><li>error äº‹ä»¶ï¼šå½“å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚è¯¥äº‹ä»¶å¯¹è±¡çš„ event å±æ€§åŒ…å«äº†é”™è¯¯ä¿¡æ¯ã€‚</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// åˆå§‹åŒ– eventSource ç­‰çœç•¥</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">open</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Connection opened</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">message</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Received message: </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">event</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶</span></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Received message: </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">event</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Error occurred: </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">event</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">event</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre></div><p>â€‹ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨å±æ€§ç›‘å¬ï¼ˆ<code>onopen</code>ã€<code>onmessage</code>ã€<code>onerror</code>ï¼‰çš„å½¢å¼ã€‚</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">/</span><span style="color:#BABED8;"> åˆå§‹åŒ– eventSource ç­‰çœç•¥</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onopen</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Connection opened</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onmessage</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Received message: </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">event</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">eventSource</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onerror</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Error occurred: </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">event</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">event</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre></div><blockquote><p>ğŸ“¢æ³¨æ„ï¼š</p><p><code>EventSource</code> å¯¹è±¡çš„å±æ€§ç›‘å¬åªèƒ½ç›‘å¬é¢„å®šä¹‰çš„äº‹ä»¶ç±»å‹ï¼ˆ<code>open</code>ã€<code>message</code>ã€<code>error</code>ï¼‰ã€‚ä¸èƒ½ç”¨äºç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ç±»å‹ã€‚å¦‚æœè¦å®ç°è‡ªå®šä¹‰äº‹ä»¶ç±»å‹çš„ç›‘å¬ï¼Œå¯ä»¥ä½¿ç”¨ <code>addEventListener()</code> æ–¹æ³•ã€‚</p></blockquote><h2 id="_5-å®è·µ" tabindex="-1">5 å®è·µ <a class="header-anchor" href="#_5-å®è·µ" aria-label="Permalink to &quot;5 å®è·µ&quot;">â€‹</a></h2><h3 id="_5-1-æœåŠ¡ç«¯" tabindex="-1">5.1 æœåŠ¡ç«¯ <a class="header-anchor" href="#_5-1-æœåŠ¡ç«¯" aria-label="Permalink to &quot;5.1 æœåŠ¡ç«¯&quot;">â€‹</a></h3><p>â€‹ ä½¿ç”¨ Node.js å®ç° SSE çš„ç®€å•ç¤ºä¾‹ï¼š</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> http </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">http</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createServer</span><span style="color:#BABED8;">((req</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> res) </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  const url </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> req</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">url</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">url</span><span style="color:#BABED8;"> === </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> || </span><span style="color:#BABED8;font-style:italic;">url</span><span style="color:#BABED8;"> === </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index.html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœè¯·æ±‚æ ¹è·¯å¾„ï¼Œè¿”å› index.html æ–‡ä»¶</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index.html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">err</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">data</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      if </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">err</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">500</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Error loading</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> else </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Content-Type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text/html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> else </span><span style="color:#F07178;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">url.includes(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/sse</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœè¯·æ±‚ /events è·¯å¾„ï¼Œå»ºç«‹ SSE è¿æ¥</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Content-Type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text/event-stream</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Cache-Control</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">no-cache</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Connection</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">keep-alive</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Access-Control-Allow-Origin</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å…è®¸è·¨åŸŸ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ¯éš” 1 ç§’å‘é€ä¸€æ¡æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">intervalId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">setInterval</span><span style="color:#F07178;">(() </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      res.write(</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">event: customEvent</span><span style="color:#BABED8;">\\n</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      res.write(</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">id: </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">\\n</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      res.write(</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">retry: 30000</span><span style="color:#BABED8;">\\n</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      const params = url.split(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">?</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)[1]</span></span>
<span class="line"><span style="color:#F07178;">      const data = { id, time</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Date</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toISOString</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">params</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">write</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">data: </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#BABED8;">(data)</span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">\\n\\n</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">;</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        clearInterval</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">intervalId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        res.end</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    }</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å½“å®¢æˆ·ç«¯å…³é—­è¿æ¥æ—¶åœæ­¢å‘é€æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">req</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">close</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> () </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      clearInterval</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">intervalId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">      id = 0</span></span>
<span class="line"><span style="color:#F07178;">      res.end</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> else </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœè¯·æ±‚çš„è·¯å¾„æ— æ•ˆï¼Œè¿”å› 404 çŠ¶æ€ç </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">404</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#BABED8;">(</span><span style="color:#F78C6C;">3000</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Server listening on port 3000</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span></code></pre></div><h3 id="_5-2-æµè§ˆå™¨" tabindex="-1">5.2 æµè§ˆå™¨ <a class="header-anchor" href="#_5-2-æµè§ˆå™¨" aria-label="Permalink to &quot;5.2 æµè§ˆå™¨&quot;">â€‹</a></h3><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">&amp;lt;!DOCTYPE html&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;html lang=&quot;en&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;head&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;meta charset=&quot;UTF-8&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;title&amp;gt;SSE Demo&amp;lt;/title&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;/head&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;body&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;h1&amp;gt;SSE Demo&amp;lt;/h1&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;button onclick=&quot;connectSSE()&quot;&amp;gt;å»ºç«‹ SSE è¿æ¥&amp;lt;/button&amp;gt;  </span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;button onclick=&quot;closeSSE()&quot;&amp;gt;æ–­å¼€ SSE è¿æ¥&amp;lt;/button&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;br /&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;br /&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;div id=&quot;message&quot;&amp;gt;&amp;lt;/div&amp;gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;script&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">    const messageElement = document.getElementById(&#39;message&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    let eventSource</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    // å»ºç«‹ SSE è¿æ¥</span></span>
<span class="line"><span style="color:#BABED8;">    const connectSSE = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">      eventSource = new EventSource(&#39;http://127.0.0.1:3000/sse?content=xxx&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      // ç›‘å¬æ¶ˆæ¯äº‹ä»¶</span></span>
<span class="line"><span style="color:#BABED8;">      eventSource.addEventListener(&#39;customEvent&#39;, (event) =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">        const data = JSON.parse(event.data)</span></span>
<span class="line"><span style="color:#BABED8;">        messageElement.innerHTML += \`\${data.id} --- \${data.time} --- paramså‚æ•°ï¼š\${JSON.stringify(data.params)}\` + &#39;&amp;lt;br /&amp;gt;&#39;</span></span>
<span class="line"><span style="color:#BABED8;">      })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      eventSource.onopen = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">        messageElement.innerHTML += \`SSE è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€\${eventSource.readyState}&amp;lt;br /&amp;gt;\`</span></span>
<span class="line"><span style="color:#BABED8;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      eventSource.onerror = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">        messageElement.innerHTML += \`SSE è¿æ¥é”™è¯¯ï¼ŒçŠ¶æ€\${eventSource.readyState}&amp;lt;br /&amp;gt;\`</span></span>
<span class="line"><span style="color:#BABED8;">      }</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    // æ–­å¼€ SSE è¿æ¥</span></span>
<span class="line"><span style="color:#BABED8;">    const closeSSE = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">      eventSource.close()</span></span>
<span class="line"><span style="color:#BABED8;">      messageElement.innerHTML += \`SSE è¿æ¥å…³é—­ï¼ŒçŠ¶æ€\${eventSource.readyState}&amp;lt;br /&amp;gt;\`</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;/script&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;/body&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;/html&amp;gt;</span></span></code></pre></div><p>â€‹ å°†ä¸Šé¢çš„ä¸¤ä»½ä»£ç ä¿å­˜ä¸º <code>server.js</code> å’Œ <code>index.html</code>ï¼Œå¹¶åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ <code>node server.js</code> å¯åŠ¨æœåŠ¡ç«¯ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://localhost:3000</code> å³å¯çœ‹åˆ° SSE æ•ˆæœã€‚</p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4afccb9879064c06b664607588697b09~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image" alt="2023-05-09 21.12.02" loading="lazy"><h2 id="_6-å…¼å®¹æ€§" tabindex="-1">6 å…¼å®¹æ€§ <a class="header-anchor" href="#_6-å…¼å®¹æ€§" aria-label="Permalink to &quot;6 å…¼å®¹æ€§&quot;">â€‹</a></h2>`,65)),n("p",null,[s[0]||(s[0]=a("â€‹ å‘å±•è‡³ä»Šï¼ŒSSE å·²å…·æœ‰å¹¿æ³›çš„çš„æµè§ˆå™¨")),n("a",r,"å…¼å®¹æ€§",512),s[1]||(s[1]=a("ï¼Œå‡ ä¹é™¤ IE ä¹‹å¤–çš„æµè§ˆå™¨å‡å·²æ”¯æŒã€‚"))]),s[11]||(s[11]=n("p",null,[n("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eff4e8ec907d4460a412e5b669a39ef0~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image",alt:"image-20230409024847028",loading:"lazy"})],-1)),n("p",null,[s[2]||(s[2]=a("â€‹ å¯¹äºä¸æ”¯æŒ EventSource çš„æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ ")),n("a",y,"polyfill",512),s[3]||(s[3]=a(" å®ç°ã€‚åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æ”¯æŒ EventSourceï¼š"))]),s[12]||(s[12]=l(`<div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;">(EventSource) </span><span style="color:#89DDFF;">!==</span><span style="color:#BABED8;"> â€œ</span><span style="color:#89DDFF;">undefined</span><span style="color:#BABED8;">â€) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// æ”¯æŒ</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// ä¸æ”¯æŒï¼Œä½¿ç”¨ polyfill</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="_7-fetch-å®ç°" tabindex="-1">7 Fetch å®ç° <a class="header-anchor" href="#_7-fetch-å®ç°" aria-label="Permalink to &quot;7 Fetch å®ç°&quot;">â€‹</a></h2>`,2)),n("p",null,[s[4]||(s[4]=a("â€‹ è™½ç„¶ä½¿ç”¨ SSE æŠ€æœ¯å¯ä»¥å®ç° ChatGPT ä¸€æ ·çš„æ‰“å­—æœºæ•ˆæœï¼Œä½†æ˜¯é€šè¿‡ä¸Šæ–‡è¯·æ±‚ type å¯¹æ¯”å¯ä»¥å‘ç°ï¼Œåœ¨ä½¿ç”¨ SSE æ—¶ï¼Œtype ä¸º ")),s[5]||(s[5]=n("code",null,"eventSource",-1)),s[6]||(s[6]=a("ï¼Œè€Œ ChatGPT ä¸º ")),s[7]||(s[7]=n("code",null,"fetch",-1)),s[8]||(s[8]=a("ã€‚ä¸”å—æµè§ˆå™¨ EventSource API é™åˆ¶ï¼Œåœ¨ä½¿ç”¨ SSE æ—¶ä¸èƒ½è‡ªå®šä¹‰è¯·æ±‚å¤´ã€åªèƒ½å‘å‡º GET è¯·æ±‚ï¼Œä¸”åœ¨å¤§å¤šæ•°æµè§ˆå™¨ä¸­ï¼ŒURL é™åˆ¶ ")),n("a",F,"2000ä¸ªå­—ç¬¦",512),s[9]||(s[9]=a("ï¼Œä¹Ÿæ— æ³•æ»¡è¶³ ChatGPT å‚æ•°ä¼ é€’éœ€æ±‚ã€‚"))]),s[13]||(s[13]=l(`<p>â€‹ æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Fetch API å®ç°ä¸€ä¸ªæ›¿ä»£æ¥å£ï¼Œç”¨äº<strong>æ¨¡æ‹Ÿ</strong> SSE å®ç°ã€‚ç®€å•å®ç°å¦‚ä¸‹ï¼š</p><h3 id="_7-1-æœåŠ¡ç«¯" tabindex="-1">7.1 æœåŠ¡ç«¯ <a class="header-anchor" href="#_7-1-æœåŠ¡ç«¯" aria-label="Permalink to &quot;7.1 æœåŠ¡ç«¯&quot;">â€‹</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> http </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">http</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createServer</span><span style="color:#BABED8;">((req</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> res) </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  const url </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> req</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">url</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">url</span><span style="color:#BABED8;"> === </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> || </span><span style="color:#BABED8;font-style:italic;">url</span><span style="color:#BABED8;"> === </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index-fetch.html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœè¯·æ±‚æ ¹è·¯å¾„ï¼Œè¿”å› ndex-fetch.html æ–‡ä»¶</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index-fetch.html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">err</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">data</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      if </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">err</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">500</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Error loading</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> else </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Content-Type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text/html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> else </span><span style="color:#F07178;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">url.includes(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/fetch-sse</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœè¯·æ±‚ /events-fetch è·¯å¾„ï¼Œå»ºç«‹è¿æ¥</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Content-Type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text/event-stream</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Cache-Control</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">no-cache</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Connection</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">keep-alive</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">Access-Control-Allow-Origin</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å…è®¸è·¨åŸŸ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">body</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">req</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">data</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">chunk</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      body += </span><span style="color:#BABED8;">chunk</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ¯éš” 1 ç§’å‘é€ä¸€æ¡æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">intervalId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">setInterval</span><span style="color:#F07178;">(() </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      const </span><span style="color:#BABED8;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Date</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toISOString</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> body</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">body</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      res.write(JSON.stringify(data))</span></span>
<span class="line"><span style="color:#F07178;">      id++</span></span>
<span class="line"><span style="color:#F07178;">      if </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">id</span><span style="color:#F07178;"> &amp;</span><span style="color:#BABED8;font-style:italic;">gt</span><span style="color:#F07178;">;</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">clearInterval</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">intervalId</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å½“å®¢æˆ·ç«¯å…³é—­è¿æ¥æ—¶åœæ­¢å‘é€æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">req</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">close</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> () </span><span style="color:#89DDFF;">=&amp;</span><span style="color:#BABED8;">gt</span><span style="color:#F07178;">; </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      clearInterval</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">intervalId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">      id = 0</span></span>
<span class="line"><span style="color:#F07178;">      res.end</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> else </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœè¯·æ±‚çš„è·¯å¾„æ— æ•ˆï¼Œè¿”å› 404 çŠ¶æ€ç </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeHead</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">404</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#BABED8;">(</span><span style="color:#F78C6C;">3001</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Server listening on port 3001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span></code></pre></div><h3 id="_7-2-æµè§ˆå™¨" tabindex="-1">7.2 æµè§ˆå™¨ <a class="header-anchor" href="#_7-2-æµè§ˆå™¨" aria-label="Permalink to &quot;7.2 æµè§ˆå™¨&quot;">â€‹</a></h3><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">&amp;lt;!DOCTYPE html&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;html lang=&quot;en&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;head&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;meta charset=&quot;UTF-8&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;title&amp;gt;fetchSSE Demo&amp;lt;/title&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;/head&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;body&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;h1&amp;gt;fetchSSE Demo&amp;lt;/h1&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;button onclick=&quot;connectFetch()&quot;&amp;gt;å»ºç«‹ fetchSSE è¿æ¥&amp;lt;/button&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;button onclick=&quot;closeSSE()&quot;&amp;gt;æ–­å¼€ fetchSSE è¿æ¥&amp;lt;/button&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;br /&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;br /&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;div id=&quot;message&quot;&amp;gt;&amp;lt;/div&amp;gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  &amp;lt;script&amp;gt;</span></span>
<span class="line"><span style="color:#BABED8;">    const messageElement = document.getElementById(&#39;message&#39;)</span></span>
<span class="line"><span style="color:#BABED8;">    let controller</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    // å»ºç«‹ FETCH-SSE è¿æ¥</span></span>
<span class="line"><span style="color:#BABED8;">    const connectFetch = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">      controller = new AbortController()</span></span>
<span class="line"><span style="color:#BABED8;">      fetchEventSource(&#39;http://127.0.0.1:3001/fetch-sse&#39;, {</span></span>
<span class="line"><span style="color:#BABED8;">        method: &#39;POST&#39;,</span></span>
<span class="line"><span style="color:#BABED8;">        body: JSON.stringify({</span></span>
<span class="line"><span style="color:#BABED8;">          content: &#39;xxx&#39;</span></span>
<span class="line"><span style="color:#BABED8;">        }),</span></span>
<span class="line"><span style="color:#BABED8;">        signal: controller.signal,</span></span>
<span class="line"><span style="color:#BABED8;">        onopen: () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          messageElement.innerHTML += \`FETCH è¿æ¥æˆåŠŸ&amp;lt;br /&amp;gt;\`</span></span>
<span class="line"><span style="color:#BABED8;">        },</span></span>
<span class="line"><span style="color:#BABED8;">        onclose: () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          messageElement.innerHTML += \`FETCH è¿æ¥å…³é—­&amp;lt;br /&amp;gt;\`</span></span>
<span class="line"><span style="color:#BABED8;">        },</span></span>
<span class="line"><span style="color:#BABED8;">        onmessage: (event) =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          const data = JSON.parse(event)</span></span>
<span class="line"><span style="color:#BABED8;">          messageElement.innerHTML += \`\${data.id} --- \${data.time} --- bodyå‚æ•°ï¼š\${JSON.stringify(data.body)}\` + &#39;&amp;lt;br /&amp;gt;&#39;</span></span>
<span class="line"><span style="color:#BABED8;">        },</span></span>
<span class="line"><span style="color:#BABED8;">        onerror: (e) =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          console.log(e)</span></span>
<span class="line"><span style="color:#BABED8;">        }</span></span>
<span class="line"><span style="color:#BABED8;">      })</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    // æ–­å¼€ FETCH-SSE è¿æ¥</span></span>
<span class="line"><span style="color:#BABED8;">    const closeSSE = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">      if (controller) {</span></span>
<span class="line"><span style="color:#BABED8;">        controller.abort()</span></span>
<span class="line"><span style="color:#BABED8;">        controller = undefined</span></span>
<span class="line"><span style="color:#BABED8;">        messageElement.innerHTML += \`FETCH è¿æ¥å…³é—­&amp;lt;br /&amp;gt;\`</span></span>
<span class="line"><span style="color:#BABED8;">      }</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    const fetchEventSource = (url, options) =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">      fetch(url, options)</span></span>
<span class="line"><span style="color:#BABED8;">        .then(response =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          if (response.status === 200) {</span></span>
<span class="line"><span style="color:#BABED8;">            options.onopen &amp;amp;&amp;amp; options.onopen()</span></span>
<span class="line"><span style="color:#BABED8;">            return response.body</span></span>
<span class="line"><span style="color:#BABED8;">          }</span></span>
<span class="line"><span style="color:#BABED8;">        })</span></span>
<span class="line"><span style="color:#BABED8;">        .then(rb =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          const reader = rb.getReader()</span></span>
<span class="line"><span style="color:#BABED8;">            const push = () =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">              // done ä¸ºæ•°æ®æµæ˜¯å¦æ¥æ”¶å®Œæˆï¼Œboolean</span></span>
<span class="line"><span style="color:#BABED8;">              // value ä¸ºè¿”å›æ•°æ®ï¼ŒUint8Array</span></span>
<span class="line"><span style="color:#BABED8;">              return reader.read().then(({done, value}) =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">                if (done) {</span></span>
<span class="line"><span style="color:#BABED8;">                  options.onclose &amp;amp;&amp;amp; options.onclose()</span></span>
<span class="line"><span style="color:#BABED8;">                  return</span></span>
<span class="line"><span style="color:#BABED8;">                }</span></span>
<span class="line"><span style="color:#BABED8;">                options.onmessage &amp;amp;&amp;amp; options.onmessage(new TextDecoder().decode(value))</span></span>
<span class="line"><span style="color:#BABED8;">                // æŒç»­è¯»å–æµä¿¡æ¯</span></span>
<span class="line"><span style="color:#BABED8;">                return push()</span></span>
<span class="line"><span style="color:#BABED8;">              })</span></span>
<span class="line"><span style="color:#BABED8;">            }</span></span>
<span class="line"><span style="color:#BABED8;">            // å¼€å§‹è¯»å–æµä¿¡æ¯</span></span>
<span class="line"><span style="color:#BABED8;">            return push()</span></span>
<span class="line"><span style="color:#BABED8;">        })</span></span>
<span class="line"><span style="color:#BABED8;">        .catch((e) =&amp;gt; {</span></span>
<span class="line"><span style="color:#BABED8;">          options.error &amp;amp;&amp;amp; options.error(e)</span></span>
<span class="line"><span style="color:#BABED8;">        })</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;/script&amp;gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">&amp;lt;/html&amp;gt;</span></span></code></pre></div><blockquote><p>ğŸ’¡ä¸åŒäº <code>XMLHttpRequest</code>ï¼Œ<code>fetch</code> å¹¶æœªåŸç”Ÿæä¾›ç»ˆæ­¢æ“ä½œæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ DOM API <code>[AbortController](https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController)</code> å’Œ <code>AbortSignal</code> å®ç° fetch è¯·æ±‚ç»ˆæ­¢æ“ä½œã€‚</p></blockquote><p>â€‹ å°†ä¸Šé¢çš„ä¸¤ä»½ä»£ç ä¿å­˜ä¸º <code>server-fetch.js</code> å’Œ <code>index-fetch.html</code>ï¼Œå¹¶åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ <code>node server-fetch.js</code> å¯åŠ¨æœåŠ¡ç«¯ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://localhost:3001</code> å³å¯çœ‹åˆ° fetch ç‰ˆ SSE æ•ˆæœã€‚</p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74bc1bbfcbf347fea8e09db768460e38~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.image" alt="2023-05-09 21.14.46" loading="lazy"><h2 id="_8-æ€»ç»“" tabindex="-1">8 æ€»ç»“ <a class="header-anchor" href="#_8-æ€»ç»“" aria-label="Permalink to &quot;8 æ€»ç»“&quot;">â€‹</a></h2><p>â€‹ SSE æŠ€æœ¯æ˜¯ä¸€ç§è½»é‡çº§çš„å®æ—¶é€šä¿¡æŠ€æœ¯ï¼ŒåŸºäº HTTP åè®®ï¼Œå…·æœ‰æœåŠ¡ç«¯æ¨é€ã€æ–­çº¿é‡è¿ã€ç®€å•è½»é‡ç­‰ä¼˜ç‚¹ã€‚ä½†æ˜¯ï¼ŒSSE æŠ€æœ¯ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå¦‚ä¸èƒ½è¿›è¡ŒåŒå‘é€šä¿¡ã€è¿æ¥æ•°å—é™ã€ä»…æ”¯æŒ get è¯·æ±‚ç­‰ã€‚</p><p>â€‹ SSE å¯ä»¥åœ¨ Web åº”ç”¨ç¨‹åºä¸­å®ç°è¯¸å¦‚è‚¡ç¥¨åœ¨çº¿æ•°æ®ã€æ—¥å¿—æ¨é€ã€èŠå¤©å®¤å®æ—¶äººæ•°ç­‰å³æ—¶æ•°æ®æ¨é€åŠŸèƒ½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSSE å¹¶ä¸æ˜¯é€‚ç”¨äºæ‰€æœ‰çš„å®æ—¶æ¨é€åœºæ™¯ã€‚åœ¨éœ€è¦é«˜å¹¶å‘ã€é«˜ååé‡å’Œä½å»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼ŒWebSockets å¯èƒ½æ›´åŠ é€‚åˆã€‚è€Œåœ¨éœ€è¦æ›´è½»é‡çº§çš„æ¨é€åœºæ™¯ä¸‹ï¼ŒSSE å¯èƒ½æ›´åŠ é€‚åˆã€‚å› æ­¤ï¼Œåœ¨é€‰æ‹©å³æ—¶æ›´æ–°æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„éœ€æ±‚å’Œåœºæ™¯è¿›è¡Œé€‰æ‹©ã€‚</p>`,11))])])}const h=p(t,[["render",D]]);export{u as __pageData,h as default};
